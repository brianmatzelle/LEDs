#!/bin/bash
# LED Matrix Demo Store
# Browse and run apps on your 64x64 LED matrix

DIR="$(cd "$(dirname "$0")" && pwd)"
PYTHON="$DIR/.venv/bin/python"
MATRIX_IP="${MATRIX_IP:-192.168.1.184}"

# App catalog: name|file|description
APPS=(
    "G Train|apps/gtrain.py|Live Greenpoint Ave arrivals"
    "Circle|apps/circle.py|Pulsing color-cycling circle"
    "Rainbow|apps/rainbow.py|Scrolling diagonal rainbow wave"
    "Plasma|apps/plasma.py|Classic demoscene plasma effect"
    "Hello|apps/hello.py|Bouncing text with color cycling"
    "Caesar|apps/caesar.py|Spinning ASCII 3D Caesar"
    "Valentine|apps/valentine.py|Pulsing heart love note"
    "Sports|apps/sports.py|Multi-team sports tracker"
    "Garvis|apps/garvis.py|Voice assistant face + captions"
    "Chooser|apps/chooser.py|Cycle demos with board buttons"
)

show_banner() {
    clear
    echo ""
    echo "  ╔══════════════════════════════════════╗"
    echo "  ║     LED MATRIX DEMO STORE  64x64     ║"
    echo "  ╠══════════════════════════════════════╣"
    echo "  ║  Browse demos. Pick one. Enjoy.      ║"
    echo "  ╚══════════════════════════════════════╝"
    echo ""
    echo "  Board IP: $MATRIX_IP"
    echo ""
}

show_menu() {
    echo "  ┌──────────────────────────────────────┐"
    printf "  │  %-36s │\n" "DEMOS"
    echo "  ├──────────────────────────────────────┤"
    local i=1
    for app in "${APPS[@]}"; do
        IFS='|' read -r name file desc <<< "$app"
        printf "  │ %2d) %-10s %-23s │\n" "$i" "$name" "$desc"
        ((i++))
    done
    echo "  ├──────────────────────────────────────┤"
    printf "  │  %-36s │\n" "g) Garvis Server (voice pipeline)"
    printf "  │  %-36s │\n" "s) Simulator only (no board)"
    printf "  │  %-36s │\n" "q) Quit"
    echo "  └──────────────────────────────────────┘"
    echo ""
}

run_app() {
    local file="$1"
    local name="$2"
    local mode="$3"

    echo ""
    if [[ "$mode" == "sim" ]]; then
        echo "  Starting $name (simulator only)..."
        echo "  Close the window or press Ctrl+C to stop."
        echo ""
        "$PYTHON" "$DIR/$file" 2>&1
    else
        echo "  Streaming $name to board..."
        echo "  Close the window or press Ctrl+C to stop."
        echo ""
        MATRIX_IP="$MATRIX_IP" "$PYTHON" "$DIR/$file" 2>&1
    fi
}

# Main loop
SIM_MODE=""

while true; do
    show_banner
    if [[ -n "$SIM_MODE" ]]; then
        echo "  Mode: SIMULATOR ONLY"
        echo ""
    fi
    show_menu

    read -rp "  Pick a demo: " choice

    case "$choice" in
        g|G)
            GARVIS_ASSISTANT="true"
            while true; do
                clear
                echo ""
                echo "  ┌──────────────────────────────────────┐"
                printf "  │  %-36s │\n" "GARVIS VOICE SERVER"
                echo "  ├──────────────────────────────────────┤"
                if [[ "$GARVIS_ASSISTANT" == "true" ]]; then
                    printf "  │  %-36s │\n" "Assistant mode: ON (wake word)"
                else
                    printf "  │  %-36s │\n" "Assistant mode: OFF (always respond)"
                fi
                echo "  ├──────────────────────────────────────┤"
                printf "  │  %-36s │\n" "a) Toggle assistant mode"
                printf "  │  %-36s │\n" "s) Start server"
                printf "  │  %-36s │\n" "q) Back"
                echo "  └──────────────────────────────────────┘"
                echo ""
                read -rp "  Choice: " gchoice
                case "$gchoice" in
                    a|A)
                        if [[ "$GARVIS_ASSISTANT" == "true" ]]; then
                            GARVIS_ASSISTANT="false"
                        else
                            GARVIS_ASSISTANT="true"
                        fi
                        ;;
                    s|S)
                        echo ""
                        echo "  Starting Garvis Voice Server..."
                        echo "  Press Ctrl+C to stop."
                        echo ""
                        ASSISTANT_MODE="$GARVIS_ASSISTANT" "$PYTHON" "$DIR/server/garvis_server.py" 2>&1
                        break
                        ;;
                    q|Q) break ;;
                    *) ;;
                esac
            done
            ;;
        s|S)
            if [[ -n "$SIM_MODE" ]]; then
                SIM_MODE=""
                echo "  Switched to STREAM mode (board + simulator)"
            else
                SIM_MODE="sim"
                echo "  Switched to SIMULATOR ONLY mode"
            fi
            sleep 1
            continue
            ;;
        q|Q)
            echo ""
            echo "  Bye!"
            echo ""
            exit 0
            ;;
        [1-9]|1[0-9])
            idx=$((choice - 1))
            if [[ $idx -lt ${#APPS[@]} ]]; then
                IFS='|' read -r name file desc <<< "${APPS[$idx]}"
                run_app "$file" "$name" "$SIM_MODE"
            else
                echo "  Invalid choice."
                sleep 1
            fi
            ;;
        *)
            echo "  Invalid choice."
            sleep 1
            ;;
    esac
done
